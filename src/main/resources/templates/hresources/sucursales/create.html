<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Crear Sucursal</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="/css/output.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        #map { height: 400px; width: 100%; margin-bottom: 1rem; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">
    <!-- 1. Main Navigation -->
    <div th:replace="~{fragments/nav :: main(activeModule='hresources')}"></div>

    <div class="container mx-auto mt-10">
        <!-- 2. Secondary Tabs -->
        <div th:replace="~{fragments/tabs :: hresources(activeTab='sucursales')}"></div>

        <!-- 3. Content Card -->
        <div class="p-6 bg-white rounded-b-lg shadow-lg rounded-tr-lg border border-gray-200">
            <div class="mb-6 text-center">
                <h1 class="text-2xl font-bold text-gray-800">Crear Nueva Sucursal</h1>
            </div>
            <form action="/sucursales/create" th:object="${sucursalForm}" method="post">
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2 required">Establecimiento</label>
                    <select th:field="*{idEstablecimiento}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Seleccione...</option>
                        <option th:each="e : ${establecimientos}" th:value="${e.id}" th:text="${e.txNombre}"></option>
                    </select>
                    <p th:if="${#fields.hasErrors('idEstablecimiento')}" th:errors="*{idEstablecimiento}" class="text-rose-500 text-xs italic mt-1"></p>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2 required">Nombre de la Sucursal</label>
                    <input type="text" th:field="*{nombre}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <p th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="text-rose-500 text-xs italic mt-1"></p>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2 required">Ubicación</label>
                    <div id="map"></div>
                    <p class="text-sm text-gray-600 mb-2">Haga clic en el mapa para seleccionar la ubicación.</p>
                    
                    <input type="hidden" id="latitud" th:field="*{latitud}">
                    <input type="hidden" id="longitud" th:field="*{longitud}">
                    
                    <p th:if="${#fields.hasErrors('latitud')}" class="text-rose-500 text-xs italic mt-1">Debe seleccionar una ubicación en el mapa.</p>
                </div>

                <div class="flex items-center justify-between gap-4">
                    <button type="submit" class="bg-teal-500 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Crear Sucursal</button>
                    <button type="button" onclick="window.location.href='/sucursales/list'" class="inline-block align-baseline font-bold text-sm text-teal-500 hover:text-teal-800">Volver a la lista</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize map centered on Mexico City
        var map = L.map('map').setView([19.4326, -99.1332], 13);
        var marker;

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <button type="button" onclick="window.location.href='http://www.openstreetmap.org/copyright'" >OpenStreetMap</button>'
        }).addTo(map);

        function onMapClick(e) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker(e.latlng).addTo(map);
            document.getElementById('latitud').value = e.latlng.lat;
            document.getElementById('longitud').value = e.latlng.lng;
        }

        map.on('click', onMapClick);
    </script>
</body>
</html>
